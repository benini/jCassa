<html>
<head>
	<link rel="stylesheet" type="text/css" href="config/colori.css">
	<link rel="stylesheet" type="text/css" href="jcassa.css">

	<script type='application/javascript' src='fastclick.js'></script>
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
</head>
<body style="background-color: black;">

<audio id="click_snd" src="click.ogg"></audio>

<div id="unknow-width-and-height" style="overflow: auto; position: fixed; left: 0px; top: 0px;">
    <div id="prezzi" style="width:100%"></div>    
</div>

<div id="unknow-height" style="overflow: auto; position: fixed; right: 0px; top: 0px;">
    <div id="scontr"></div>
</div>

<div id="unknow-width" style="overflow: auto; position: fixed; left: 0px; bottom: 0px;">
	<table><tr id="reparti"></tr></table>
</div>

<div style="position: fixed; right: 0px; bottom: 4px;">
	<div id="tot1" class="metro-tile tile-contanti metro-tile-blue">
		<div id="tot1_riga1">TOTALE</div>
		<div id="tot1_riga2"></div>
	</div>
</div>



<div id="modalInput" style="
position:absolute;
left:0px;
top:0px;
z-index: 5;
display:none;">

<div style="
position:absolute;
left:0px;
top:0px;
width: 100%; height: 100%;
background-color:#333333;
z-index: -1;
opacity: 0.80;">
</div>

<div class="metro-tile" onclick="modalInputAnnulla();">
</div>

<table class="keypad">
<tr><td> 1 </td><td> 2 </td><td> 3 </td></tr>
<tr><td> 4 </td><td> 5 </td><td> 6 </td></tr>
<tr><td> 7 </td><td> 8 </td><td> 9 </td></tr>
<tr><td> 0 </td><td> 00 </td><td style="color: red"> C </td></tr>
</table>

</div>

<script>
/*
Ci vogliono diverse finestre di input:
1) Click su prodotto-nello-scontrino: Cambio quantità e prezzo
2) Click su subtotale: Scelta totali (contanti di default) e fattura (e buoni pasto?)
3) Click su totale-disabilitato-perchè-scontrino-chiuso: Lettura e chiusura di cassa, ristampa ultimo scontrino dgfe, stampa giornata dgfe, cambia prodotti
4) Click su tile-resto dopo chiusura scontrino: Calcolo manuale del resto
*/

function modalInput() {
	document.getElementById("modalInput").style.display = "block";
}

function modalInputAnnulla() {
	document.getElementById("modalInput").style.display = "none";
}
</script>

<script type="text/javascript">
	// Caricamento FastClick per iPad
	window.addEventListener('load', function() { new FastClick(document.body); dyn_dimensions(); }, false);


	// Calcolo della dimensione della sezione "prezzi" in base alla spazio disponbile
	function dyn_dimensions() {
        // L'idea originale era di creare due classi unknown-width e unknown-height e assegnarle
        // agli oggetti che ne avevano bisogno, ma è più complicato di quanto pensassi senza jQuery
        // e per adesso voglio scrivere puro Javascript per imparare i dettagli
		var dyn_height = window.innerHeight - Math.floor(1.20 * document.getElementById("tot1").offsetHeight);
		var dyn_width = window.innerWidth - Math.floor(1.05 * document.getElementById("tot1").offsetWidth);

		document.getElementById("unknow-width-and-height").style.width = dyn_width;
		document.getElementById("unknow-width-and-height").style.height = dyn_height;
		document.getElementById("unknow-width").style.width = dyn_width;
		document.getElementById("unknow-height").style.height = dyn_height;

        document.getElementById("modalInput").style.width = dyn_width;
        document.getElementById("modalInput").style.height = window.innerHeight;
	}
	window.onresize=function() { dyn_dimensions(); }


	function animaClick(uiEvent) {
		return function () {
			this.className = this.className.replace(" tile_reset", "");
			this.className += " tile_middle";
			var tile = this;
			setTimeout(function() {tile.className = tile.className.replace(" tile_middle", " tile_reset");}, 100);
			document.getElementById("click_snd").play();

			uiEvent();
		}
	}

	function animaSelezionaRigaScontrino(divTile) {
		var scontr_last_sel = document.getElementById("scontr_selected");
		if (scontr_last_sel) {
			scontr_last_sel.className = scontr_last_sel.className.replace(" tile-scontrino-selected", "");
			scontr_last_sel.id = "";
		}
		divTile.className += " tile-scontrino-selected";
		divTile.id = "scontr_selected";
		divTile.scrollIntoView();
	}


	function uiEventCambiaReparto (r) {
		return function () {
		    var table=document.getElementById("prezzi");
		    while (table.hasChildNodes()) { table.removeChild(table.lastChild); }

			var pr_array = reparti[r].prezzi;
			for (var i=0; i < pr_array.length; i++) {
				var divTile = document.createElement("div");
				divTile.className = "metro-tile " + reparti[r].col + " tile-prezzi";
				divTile.onclick = animaClick(uiEventAggiungiProdotto(r, i));
				table.appendChild(divTile);
				var divDesc = document.createElement("div");
				divDesc.className = "desc "  + reparti[r].col;
				divDesc.innerHTML = pr_array[i].desc;
				divTile.appendChild(divDesc);
				var divPrezzo = document.createElement("div");
				divPrezzo.className = "prezzo";
				if (pr_array[i].prezzo == "") { divPrezzo.innerHTML = ""; }
				else { divPrezzo.innerHTML = "&euro; " + pr_array[i].prezzo; }
				divTile.appendChild(divPrezzo);
			}
		}
	}

	function uiEventAggiungiProdotto(idx_reparto, idx_prezzo) {
		return function () {
			if (! scontrino.isAperto()) {
				var div_scontr = document.getElementById("scontr");
				while (div_scontr.hasChildNodes()) { div_scontr.removeChild(div_scontr.lastChild);	}
			}

			var prezzo = reparti[idx_reparto].prezzi[idx_prezzo].prezzo;
			var desc = reparti[idx_reparto].prezzi[idx_prezzo].desc;
			var divTile;
			var idx = scontrino.indexOf(idx_reparto, desc, prezzo);
			if (idx == -1) {
				idx = scontrino.push(idx_reparto, 1, desc, prezzo);

    			divTile = document.createElement("div");
    			divTile.className = "metro-tile tile-scontrino " + reparti[idx_reparto].col;
				divTile.onclick = animaClick(uiEventCambiaRigaScontrino(divTile));
				document.getElementById("scontr").appendChild(divTile);
			} else {
				divTile = document.getElementById("scontr").childNodes[idx];
				scontrino.righe[idx].quant += 1;
			}

  			divTile.innerHTML = desc + "<br>" + "N. " + scontrino.righe[idx].quant + "  x  &euro; " + scontrino.righe[idx].prezzo;
			animaSelezionaRigaScontrino(divTile);
			updateTotale();
		}
	}

	function updateTotale() {
		var tot = document.getElementById("tot1");
		tot.onclick = animaClick(uiEventChiudiScontrino(tot));
		document.getElementById("tot1_riga1").innerHTML = "SubTotale";
		document.getElementById("tot1_riga2").innerHTML = "&euro; " + scontrino.getTotale().toFixed(2);
	}

	function uiEventCambiaRigaScontrino(tile) {
		return function () {
			animaSelezionaRigaScontrino(tile);
			modalInput();
		}
	}

	function uiEventRiapriScontrino (tile) {
		return function () {
			scontrino.Riapri();
			document.getElementById("scontr").removeChild(tile);
			updateTotale();
			modalInputAnnulla();
		}
	}

	function uiEventChiudiScontrino (tile) {
		return function () {
			tile.onclick = animaClick(uiEventInviaScontrino(tile));
			document.getElementById("tot1_riga1").innerHTML = "";
			document.getElementById("tot1_riga2").innerHTML = "STAMPA";

			scontrino.chiudi();

   			var divTile = document.createElement("div");
			divTile.id = "TotSc";
   			divTile.className = "metro-tile tile-scontrino orange";
			divTile.onclick = animaClick(uiEventRiapriScontrino	(divTile));
			document.getElementById("scontr").appendChild(divTile);
  			divTile.innerHTML = "TOT. CONTANTI <br>  &euro; " + scontrino.getTotale().toFixed(2);
			animaSelezionaRigaScontrino(divTile);

			modalInput();
		}
	}

	function uiEventInviaScontrino(tile) {
		return function () {
			scontrino.invia();

			tile.onclick = "none";
			document.getElementById("tot1_riga1").innerHTML = "";
			document.getElementById("tot1_riga2").innerHTML = "";
			modalInputAnnulla();
			var divTile = document.getElementById("TotSc");
			divTile.onclick = "none";
		}
	}

	var scontrino = {};
	scontrino.id = [];
	scontrino.righe = [];

	scontrino.push = function (rep, quant, desc, prezzo) {
		if (scontrino.id.length != scontrino.righe.length) { scontrino.righe.length = scontrino.id.length; }
		scontrino.righe.push({rep: rep, quant: quant, desc: desc, prezzo: prezzo});
		return scontrino.id.push(scontrino.creaID(rep, desc, prezzo)) -1;
	}
	scontrino.getTotale = function () {
		var scontrino_totale = 0;
		for (var i=0; i < scontrino.righe.length; ++i) {
			scontrino_totale += scontrino.righe[i].quant * scontrino.righe[i].prezzo.replace(",",".");
		}
		return scontrino_totale;
	}
	scontrino.chiudi = function () { scontrino.id.length = 0; }
	scontrino.Riapri = function () {
		scontrino.id.length = 0;
		for (var i=0; i<scontrino.righe.length; ++i) {
			var riga = scontrino.righe[i];
			scontrino.id.push(scontrino.creaID(riga.rep, riga.desc, riga.prezzo));
		}
	}
	scontrino.isAperto = function () { return scontrino.id.length == scontrino.righe.length; }
	scontrino.creaID = function (rep, desc, prezzo) { return "r" + rep + "d" + desc + "p" + prezzo; }
	scontrino.indexOf = function (rep, desc, prezzo) {
		var id = scontrino.creaID(rep, desc, prezzo);
		return scontrino.id.indexOf(id);
	}
	scontrino.invia = function () { scontrino.id.length = 0; scontrino.righe.length = 0; }

</script>


<script type="text/javascript">

function updateReparti() {
  for (var i = 0; i < reparti.length; i++) {
    var divTile = document.createElement("div");
    divTile.className = "metro-tile tile-reparti " + reparti[i].col;
    divTile.innerHTML = reparti[i].reparto;
    divTile.onclick = animaClick(uiEventCambiaReparto(i));
	document.getElementById('reparti').insertCell(-1).appendChild(divTile);
  }
}











var reparti = [];
reparti.push({reparto: "BAR", col: "colore_caffe", prezzi: [] });
reparti.push({reparto: "PANINI", col: "colore_panini", prezzi: [] });
reparti.push({reparto: "CUCINA", col: "colore_cucina", prezzi: [
{desc: "CAFFE", prezzo: "1,10"},
{desc: "COCA", prezzo: "2,00"}
] });
reparti.push({reparto: "BAR", col: "metro-tile-purple", prezzi: [] });
reparti.push({reparto: "VINI", col: "colore_vini", prezzi: [] });
reparti.push({reparto: "BIRRE", col: "colore_birre", prezzi: [] });
reparti.push({reparto: "GELATI", col: "colore_gelati", prezzi: [] });
 var prezzi = ["BAR", "PRIMI", "PIZZE", "A", "b", "11,40", "7", "BAR", "PRIMI"];

reparti[0].prezzi.push({desc: "BAR", prezzo: ""});
reparti[0].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[1].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[1].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[1].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[2].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[2].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[2].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[2].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[2].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[3].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[3].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[3].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[3].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[3].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[3].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[3].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[4].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[4].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[4].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[4].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[4].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[4].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[5].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[5].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[5].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[5].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[5].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[5].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});
reparti[6].prezzi.push({desc: "CAFFE", prezzo: "1,10"});
reparti[6].prezzi.push({desc: "COCA", prezzo: "2,00"});
reparti[6].prezzi.push({desc: "Cappuccino", prezzo: "2,00"});
reparti[6].prezzi.push({desc: "Descrizione mooooooooooolto lunga", prezzo: "2,00"});
reparti[6].prezzi.push({desc: "TEA", prezzo: "1,80"});
reparti[6].prezzi.push({desc: "MENU PRANZO", prezzo: "11,90"});



function loadPrezzi() {
// Leggi da file onload
  updateReparti();
}

loadPrezzi();



		</script>
	</body>
</html>
